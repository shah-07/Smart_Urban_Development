<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Air Quality & Pollution Monitoring | Smart City Portal</title>
    
    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    
    <style>
        .sidebar {
            height: 100vh;
            width: 250px;
            background-color: #2c3e50;
            position: fixed;
        }
        .sidebar a {
            color: #ecf0f1;
            padding: 15px 20px;
            display: block;
            text-decoration: none;
            border-left: 4px solid transparent;
        }
        .sidebar a:hover,
        .sidebar .active {
            background-color: #3498db;
            border-left: 4px solid #ecf0f1;
        }
        .main-content {
            margin-left: 250px;
            padding: 20px;
            width: calc(100% - 250px);
        }
        .aqi-excellent { 
            background-color: #d1ecf1 !important; 
            color: #0c5460 !important; 
        }
        .aqi-good { 
            background-color: #d4edda !important; 
            color: #155724 !important; 
        }
        .aqi-poor { 
            background-color: #f8d7da !important; 
            color: #721c24 !important; 
        }
        .card {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .chart-container {
            height: 300px;
            position: relative;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar d-flex flex-column">
        <h4 class="text-white text-center mt-3 mb-4">Smart City Portal</h4>
        <a href="dashboard.html"><i class="fas fa-tachometer-alt me-2"></i>Dashboard</a>
        <a href="traffic.html"><i class="fas fa-traffic-light me-2"></i>Traffic Management</a>
        <a href="parking.html"><i class="fas fa-parking me-2"></i>Parking System</a>
        <a href="waste.html"><i class="fas fa-trash-alt me-2"></i>Waste Management</a>
        <a href="energy.html"><i class="fas fa-bolt me-2"></i>Energy Monitoring</a>
        <a href="pollution.html" class="active"><i class="fas fa-smog me-2"></i>Air Quality Monitoring</a>
        <a href="emergency.html"><i class="fas fa-ambulance me-2"></i>Emergency Response</a>
        <a href="index.html" class="mt-auto"><i class="fas fa-sign-out-alt me-2"></i>Logout</a>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <h1><i class="fas fa-smog text-primary"></i> Air Quality & Pollution Monitoring</h1>
        <p class="text-muted mb-4">
            Real-Time Monitoring Based on <strong>Sensor Data</strong>
        </p>

        <!-- AI Forecast Card -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>PM2.5 Levels & AI Forecast</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="pollutionChart"></canvas>
                </div>
                <div class="alert alert-warning mt-3 d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle me-3 fa-lg"></i>
                    <div>
                        <strong>AI Alert:</strong> Predicted PM2.5 peak at 18:00 (165 μg/m³). 
                        Consider reducing outdoor activities in affected areas.
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Table Card -->
        <div class="card">
            <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-table me-2"></i>Pollution Readings</h5>
                <span class="badge bg-info">Live Data</span>
            </div>
            <div class="card-body">
                <!-- Search and Add Controls -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control" placeholder="Search by Sensor ID, Road, or Area..." id="searchPollution">
                            <button class="btn btn-primary" type="button" id="btnSearch">Search</button>
                        </div>
                    </div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-success" id="btnAddReading" data-bs-toggle="modal" data-bs-target="#addModal">
                            <i class="fas fa-plus-circle me-2"></i>Add New Reading
                        </button>
                    </div>
                </div>

                <!-- Table -->
                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>Sensor ID</th>
                                <th>Timestamp</th>
                                <th>Air Quality</th>
                                <th>Noise (dB)</th>
                                <th>NOx (ppm)</th>
                                <th>CO₂ (ppm)</th>
                                <th>PM2.5 (μg/m³)</th>
                                <th id="actionsHeader">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="pollutionTableBody">
                            <!-- Data will be loaded here -->
                            <tr>
                                <td colspan="8" class="text-center text-muted">Loading data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination/Info -->
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div class="text-muted">
                        <small>Showing <span id="rowCount">0</span> readings</small>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-outline-secondary btn-sm" onclick="fetchPollutionData()">
                            <i class="fas fa-sync-alt me-1"></i>Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Edit Pollution Reading</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <input type="hidden" id="editSensorID">
                        <input type="hidden" id="editTimestamp">
                        
                        <div class="mb-3">
                            <label class="form-label">Air Quality</label>
                            <select class="form-control" id="editAirQuality" required>
                                <option value="Excellent">Excellent</option>
                                <option value="Good">Good</option>
                                <option value="Moderate">Moderate</option>
                                <option value="Poor">Poor</option>
                                <option value="Unhealthy">Unhealthy</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Noise Level (dB)</label>
                            <input class="form-control" type="number" step="0.01" id="editNoiseLevel" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">PM2.5 (μg/m³)</label>
                            <input class="form-control" type="number" step="0.01" id="editPM25" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">NOx (ppm)</label>
                            <input class="form-control" type="number" step="0.01" id="editNOx" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">CO₂ (ppm)</label>
                            <input class="form-control" type="number" step="0.01" id="editCO2" required>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-warning">
                                <i class="fas fa-save me-2"></i>Update Reading
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Modal -->
    <div class="modal fade" id="addModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="fas fa-plus-circle me-2"></i>Add Pollution Reading</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addForm">
                        <div class="mb-3">
                            <label class="form-label">Sensor</label>
                            <select class="form-control" id="addSensorID" required>
                                <option value="">Select Sensor...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Timestamp</label>
                            <input class="form-control" type="datetime-local" id="addTimestamp" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Air Quality</label>
                            <select class="form-control" id="addAirQuality" required>
                                <option value="Excellent">Excellent</option>
                                <option value="Good">Good</option>
                                <option value="Moderate">Moderate</option>
                                <option value="Poor">Poor</option>
                                <option value="Unhealthy">Unhealthy</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Noise Level (dB)</label>
                            <input class="form-control" type="number" step="0.01" id="addNoiseLevel" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">PM2.5 (μg/m³)</label>
                            <input class="form-control" type="number" step="0.01" id="addPM25" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">NOx (ppm)</label>
                            <input class="form-control" type="number" step="0.01" id="addNOx" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">CO₂ (ppm)</label>
                            <input class="form-control" type="number" step="0.01" id="addCO2" required>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save me-2"></i>Save Reading
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Application JS -->
    <script>
        // Configuration
        const userRole = sessionStorage.getItem('userRole') || 'admin'; // Default to admin for testing
        const API_BASE = 'http://localhost:3000/SmartUrbanDevelopment/api/pollution';
        let pollutionData = [];
        let pollutionChart = null;

        // Function to parse numeric strings to numbers
        function parseReading(reading) {
            return {
                ...reading,
                noiseLevel: parseFloat(reading.noiseLevel) || 0,
                pm25Level: parseFloat(reading.pm25Level) || 0,
                noXLevel: parseFloat(reading.noXLevel) || 0,
                co2Level: parseFloat(reading.co2Level) || 0
            };
        }

        // Apply role-based access
        function applyRoleBasedAccess() {
            const addBtn = document.getElementById('btnAddReading');
            const actionsHeader = document.getElementById('actionsHeader');
            const actionCells = document.querySelectorAll('.action-cell');

            // Default: Hide sensitive elements
            if (addBtn) addBtn.style.display = 'none';
            if (actionsHeader) actionsHeader.style.display = 'none';
            if (actionCells) {
                actionCells.forEach(cell => cell.style.display = 'none');
            }

            // Admin: Full access
            if (userRole === 'admin') {
                if (addBtn) addBtn.style.display = 'block';
                if (actionsHeader) actionsHeader.style.display = 'table-cell';
                if (actionCells) {
                    actionCells.forEach(cell => cell.style.display = 'table-cell');
                }
            }
        }

        // Fetch pollution data
        async function fetchPollutionData() {
            try {
                console.log('Fetching data from API...');
                const response = await fetch(`${API_BASE}/readings.php`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Data received, first item:', data[0]);
                
                // Parse all numeric values
                pollutionData = data.map(parseReading);
                console.log('Parsed data, first item:', pollutionData[0]);
                
                renderTable();
                renderChart();
                
            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('pollutionTableBody').innerHTML = 
                    `<tr><td colspan="8" class="text-center text-danger">
                        Error loading data. Please check console for details.
                    </td></tr>`;
            }
        }

        // Render table
        function renderTable() {
            console.log('renderTable called with', pollutionData.length, 'items');
            
            const tbody = document.getElementById('pollutionTableBody');
            console.log('Table body element found:', tbody);
            
            if (!tbody) {
                console.error('Table body element not found!');
                alert('Error: Table body element not found. Check HTML structure.');
                return;
            }
            
            if (pollutionData.length === 0) {
                console.log('No data to display');
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No data available</td></tr>';
                return;
            }

            let html = '';
            let rowCount = 0;
            
            pollutionData.forEach((reading, index) => {
                // Determine AQI class
                let aqiClass = '';
                const airQuality = reading.airQuality || '';
                
                if (airQuality.includes('Excellent')) aqiClass = 'aqi-excellent';
                else if (airQuality.includes('Good')) aqiClass = 'aqi-good';
                else if (airQuality.includes('Moderate')) aqiClass = 'aqi-good';
                else if (airQuality.includes('Poor') || airQuality.includes('Unhealthy')) aqiClass = 'aqi-poor';

                // Format timestamp
                const timestamp = new Date(reading.timestamp).toLocaleString();
                
                // Ensure values are numbers before using toFixed
                const noiseLevel = typeof reading.noiseLevel === 'number' ? reading.noiseLevel.toFixed(2) : 'N/A';
                const pm25Level = typeof reading.pm25Level === 'number' ? reading.pm25Level.toFixed(2) : 'N/A';
                const noXLevel = typeof reading.noXLevel === 'number' ? reading.noXLevel.toFixed(2) : 'N/A';
                const co2Level = typeof reading.co2Level === 'number' ? reading.co2Level.toFixed(2) : 'N/A';
                
                html += `
                    <tr>
                        <td>
                            <strong>${reading.sensorID}</strong><br>
                            <small class="text-muted">${reading.road || 'N/A'}, ${reading.area || 'N/A'}</small>
                        </td>
                        <td>${timestamp}</td>
                        <td><span class="badge rounded-pill ${aqiClass}">${airQuality || 'N/A'}</span></td>
                        <td>${noiseLevel}</td>
                        <td>${noXLevel}</td>
                        <td>${co2Level}</td>
                        <td>${pm25Level}</td>
                        <td class="action-cell" style="display: ${userRole === 'admin' ? 'table-cell' : 'none'}">
                            <button class="btn btn-sm btn-warning me-1" onclick="editReading(${reading.sensorID}, '${reading.timestamp}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteReading(${reading.sensorID}, '${reading.timestamp}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                rowCount++;
            });
            
            console.log('Generated rows:', rowCount);
            tbody.innerHTML = html;
            
            // Update row count display
            const rowCountElement = document.getElementById('rowCount');
            if (rowCountElement) {
                rowCountElement.textContent = rowCount;
            }
            
            applyRoleBasedAccess(); // Re-apply after rendering
        }

        // Render chart
        async function renderChart() {
            try {
                const response = await fetch(`${API_BASE}/chart.php`);
                const chartData = await response.json();
                
                const ctx = document.getElementById('pollutionChart');
                if (!ctx) {
                    console.error('Chart canvas not found!');
                    return;
                }
                
                // Destroy existing chart
                if (pollutionChart) {
                    pollutionChart.destroy();
                }
                
                // Parse numeric values for chart
                const parsedChartData = chartData.map(item => ({
                    ...item,
                    avg_pm25: parseFloat(item.avg_pm25) || 0,
                    avg_co2: parseFloat(item.avg_co2) || 0,
                    avg_nox: parseFloat(item.avg_nox) || 0
                }));
                
                console.log('Chart data:', parsedChartData);
                
                // Create new chart
                pollutionChart = new Chart(ctx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: parsedChartData.map(d => d.date),
                        datasets: [
                            {
                                label: 'PM2.5 (μg/m³)',
                                data: parsedChartData.map(d => d.avg_pm25),
                                borderColor: '#e74c3c',
                                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'CO₂ (ppm)',
                                data: parsedChartData.map(d => d.avg_co2),
                                borderColor: '#3498db',
                                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Concentration'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Date'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error rendering chart:', error);
            }
        }

        // Populate sensor dropdown
        async function populateSensorDropdown() {
            try {
                console.log('Fetching sensors...');
                const response = await fetch(`${API_BASE}/sensors.php`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const sensors = await response.json();
                console.log('Sensors data received:', sensors);
                
                const select = document.getElementById('addSensorID');
                if (!select) {
                    console.error('Sensor dropdown not found!');
                    return;
                }
                
                select.innerHTML = '<option value="">Select Sensor...</option>';
                
                sensors.forEach(sensor => {
                    const option = document.createElement('option');
                    option.value = sensor.sensorID;
                    option.textContent = `Sensor ${sensor.sensorID} - ${sensor.road || 'Unknown'} (${sensor.area || 'N/A'})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading sensors:', error);
            }
        }

        // Add reading
        async function addReading(event) {
            event.preventDefault();
            
            const formData = {
                sensorID: document.getElementById('addSensorID').value,
                timestamp: document.getElementById('addTimestamp').value,
                airQuality: document.getElementById('addAirQuality').value,
                noiseLevel: parseFloat(document.getElementById('addNoiseLevel').value),
                pm25Level: parseFloat(document.getElementById('addPM25').value),
                noXLevel: parseFloat(document.getElementById('addNOx').value),
                co2Level: parseFloat(document.getElementById('addCO2').value)
            };

            try {
                const response = await fetch(`${API_BASE}/readings.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    alert('Reading added successfully!');
                    
                    // Close modal and refresh
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addModal'));
                    if (modal) modal.hide();
                    
                    fetchPollutionData();
                }
            } catch (error) {
                console.error('Error adding reading:', error);
                alert('Error adding reading. Please check console for details.');
            }
        }

        // Edit reading
        async function editReading(sensorID, timestamp) {
            try {
                const response = await fetch(`${API_BASE}/reading.php?sensorID=${sensorID}&timestamp=${encodeURIComponent(timestamp)}`);
                const reading = await response.json();
                
                if (reading.error) {
                    alert('Error: ' + reading.error);
                    return;
                }
                
                // Parse the reading
                const parsedReading = parseReading(reading);
                
                // Populate form
                document.getElementById('editSensorID').value = parsedReading.sensorID;
                document.getElementById('editTimestamp').value = parsedReading.timestamp.replace(' ', 'T');
                document.getElementById('editAirQuality').value = parsedReading.airQuality;
                document.getElementById('editNoiseLevel').value = parsedReading.noiseLevel;
                document.getElementById('editPM25').value = parsedReading.pm25Level;
                document.getElementById('editNOx').value = parsedReading.noXLevel;
                document.getElementById('editCO2').value = parsedReading.co2Level;
                
                // Show modal
                new bootstrap.Modal(document.getElementById('editModal')).show();
            } catch (error) {
                console.error('Error fetching reading:', error);
                alert('Error loading reading data.');
            }
        }

        // Update reading
        async function updateReading(event) {
            event.preventDefault();
            
            const formData = {
                sensorID: document.getElementById('editSensorID').value,
                timestamp: document.getElementById('editTimestamp').value.replace('T', ' '),
                airQuality: document.getElementById('editAirQuality').value,
                noiseLevel: parseFloat(document.getElementById('editNoiseLevel').value),
                pm25Level: parseFloat(document.getElementById('editPM25').value),
                noXLevel: parseFloat(document.getElementById('editNOx').value),
                co2Level: parseFloat(document.getElementById('editCO2').value)
            };

            try {
                const response = await fetch(`${API_BASE}/reading.php`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    alert('Reading updated successfully!');
                    
                    // Close modal and refresh
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
                    if (modal) modal.hide();
                    
                    fetchPollutionData();
                }
            } catch (error) {
                console.error('Error updating reading:', error);
                alert('Error updating reading.');
            }
        }

        // Delete reading
        async function deleteReading(sensorID, timestamp) {
            if (!confirm('Are you sure you want to delete this reading?\nThis action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/reading.php?sensorID=${sensorID}&timestamp=${encodeURIComponent(timestamp)}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    alert('Reading deleted successfully!');
                    fetchPollutionData();
                }
            } catch (error) {
                console.error('Error deleting reading:', error);
                alert('Error deleting reading.');
            }
        }

        // Search functionality
        function searchReadings() {
            const searchTerm = document.getElementById('searchPollution').value.toLowerCase();
            const tbody = document.getElementById('pollutionTableBody');
            if (!tbody) return;
            
            const rows = tbody.getElementsByTagName('tr');
            
            for (let row of rows) {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded. User role:', userRole);
            
            // Apply role-based access
            applyRoleBasedAccess();
            
            // Set current datetime for add form
            const now = new Date();
            const timezoneOffset = now.getTimezoneOffset() * 60000;
            const localISOTime = new Date(now - timezoneOffset).toISOString().slice(0, 16);
            const timestampInput = document.getElementById('addTimestamp');
            if (timestampInput) {
                timestampInput.value = localISOTime;
            }
            
            // Test API connection first
            fetchPollutionData();
            
            // Populate sensor dropdown for admin
            if (userRole === 'admin') {
                populateSensorDropdown();
            }
            
            // Event listeners
            const searchBtn = document.getElementById('btnSearch');
            const searchInput = document.getElementById('searchPollution');
            const addForm = document.getElementById('addForm');
            const editForm = document.getElementById('editForm');
            
            if (searchBtn) {
                searchBtn.addEventListener('click', searchReadings);
            }
            
            if (searchInput) {
                searchInput.addEventListener('input', searchReadings);
            }
            
            if (addForm) {
                addForm.addEventListener('submit', addReading);
            }
            
            if (editForm) {
                editForm.addEventListener('submit', updateReading);
            }
            
            // For testing - set admin role if not set
            if (!sessionStorage.getItem('userRole')) {
                console.log('Setting default user role to admin for testing');
                sessionStorage.setItem('userRole', 'admin');
                location.reload();
            }
        });
    </script>
</body>
</html>