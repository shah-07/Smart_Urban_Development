<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Parking | Smart City Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        /* General Layout Styles (Consistency) */
        .sidebar {
            height: 100vh;
            background-color: #2c3e50;
            padding-top: 20px;
        }
        .sidebar a {
            color: #ecf0f1;
            padding: 15px 20px;
            text-decoration: none;
            display: block;
            border-bottom: 1px solid #34495e;
        }
        .sidebar a:hover, .sidebar .active {
            background-color: #3498db;
            color: white;
        }
        .main-content {
            padding: 30px;
        }
        /* Specific Styles */
        .spot-available { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
        .spot-reserved { background-color: #fff3cd; color: #856404; border-color: #ffeeba; }
        .spot-occupied { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .table-section {
            margin-bottom: 40px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .action-buttons {
            white-space: nowrap;
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 500;
        }
        /* Parking Grid Visualization */
        #parkingGrid {
            min-height: 80px;
        }
    </style>
</head>
<body>

<div class="d-flex">
    <div class="sidebar d-flex flex-column" style="width: 250px;">
        <h4 class="text-white text-center mb-4">Smart City Portal</h4>
        <a href="dashboard.html"><i class="fas fa-th-large me-2"></i> Dashboard</a>
        <a href="traffic.html"><i class="fas fa-car-side me-2"></i> Traffic Management</a>
        <a href="parking.html" class="active"><i class="fas fa-parking me-2"></i> Smart Parking System</a>
        <a href="waste.html"><i class="fas fa-trash-alt me-2"></i> Waste Management</a>
        <a href="energy.html"><i class="fas fa-bolt me-2"></i> Energy Monitoring</a>
        <a href="pollution.html"><i class="fas fa-smog me-2"></i> Air Quality Monitoring</a>
        <a href="emergency.html"><i class="fas fa-ambulance me-2"></i> Emergency Response</a>
        <a href="index.html" class="mt-auto" onclick="sessionStorage.removeItem('userRole');"><i class="fas fa-sign-out-alt me-2"></i> Logout</a>
    </div>

    <div class="main-content flex-grow-1">
        <header class="mb-5 border-bottom pb-3">
            <h1>Smart Parking System</h1>
            <p class="lead text-muted">Manage <strong>Parking Spot Availability</strong> and <strong>Reservations</strong></p>
        </header>

       <section class="mb-5 p-4 border rounded shadow-sm bg-white">
    <h2 class="h4 mb-3"><i class="fas fa-chart-line me-2 text-primary"></i> Revenue Analytics</h2>
    <div style="height: 300px;"><canvas id="parkingChart"></canvas></div>
    <p class="mt-3 text-center text-info">Visual representation of parking revenue over time.</p>
    </section>
        <hr>

        <!-- Table 1 - Reservations -->
        <section class="table-section">
            <h2 class="h4 mb-4"><i class="fas fa-table me-2 text-primary"></i> Table 1 - Reservations</h2>
            
            <div class="d-flex justify-content-between mb-3">
                <div class="input-group" style="width: 350px;">
                    <input type="text" class="form-control" placeholder="Search by Reservation ID or Spot ID" aria-label="Search Reservations" id="searchRes" onkeyup="filterTable('searchRes', 'resBody')">
                    <button class="btn btn-outline-secondary" type="button"><i class="fas fa-search"></i></button>
                </div>

                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addResModal">
                    <i class="fas fa-plus me-1"></i> Add New Reservation
                </button>
            </div>

            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
    <tr>
        <th>Reservation ID</th>
        <th>Spot ID</th>
        <th>Citizen ID</th>
        <th>Citizen Name</th>
        <th>Start Time</th>
        <th>End Time</th>
        <th>Amount ($)</th>  <!-- NEW COLUMN ADDED -->
        <th>Payment Gateway</th>
        <th>Payment Date</th>
        <th>Action Buttons</th>
    </tr>
</thead>
                    <tbody id="resBody"></tbody>
                </table>
            </div>
        </section>

        <!-- Table 2 - Parking Spots -->
        <section class="table-section">
            <h2 class="h4 mb-4"><i class="fas fa-parking me-2 text-primary"></i> Table 2 - Parking Spots</h2>
            
            <div class="d-flex justify-content-between mb-3">
                <div class="input-group" style="width: 350px;">
                    <input type="text" class="form-control" placeholder="Search by Spot ID or City" aria-label="Search Parking Spots" id="searchSpot" onkeyup="filterTable('searchSpot', 'spotBody')">
                    <button class="btn btn-outline-secondary" type="button"><i class="fas fa-search"></i></button>
                </div>

                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addSpotModal">
                    <i class="fas fa-plus me-1"></i> Add New Parking Spot
                </button>
            </div>

            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Spot ID</th>
                            <th>Road</th>
                            <th>Area</th>
                            <th>City</th>
                            <th>Available Status</th>
                            <th>Parking Lot Capacity</th>
                            <th>Parking Lot ID</th>
                            <th>Action Buttons</th>
                        </tr>
                    </thead>
                    <tbody id="spotBody"></tbody>
                </table>
            </div>
        </section>
    </div>
</div>

<!-- Reservation Modal -->
<div class="modal fade" id="addResModal" tabindex="-1" aria-labelledby="addResModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addResModalLabel">Add New Reservation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addResForm">
                    <div class="mb-3">
                        <label for="addResCitizen" class="form-label">Citizen *</label>
                        <select id="addResCitizen" class="form-select" required></select>
                    </div>
                    <div class="mb-3">
                        <label for="addResSpot" class="form-label">Spot *</label>
                        <select id="addResSpot" class="form-select" required></select>
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label for="addResStart" class="form-label">Start Time *</label>
                            <input type="datetime-local" id="addResStart" class="form-control" required>
                        </div>
                        <div class="col-6 mb-3">
                            <label for="addResEnd" class="form-label">End Time *</label>
                            <input type="datetime-local" id="addResEnd" class="form-control" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="addResAmount" class="form-label">Amount ($) *</label>
                        <input type="number" step="0.01" id="addResAmount" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="addResGateway" class="form-label">Payment Gateway *</label>
                        <select id="addResGateway" class="form-select" required>
                            <option value="Credit Card">Credit Card</option>
                            <option value="PayPal">PayPal</option>
                            <option value="Cash">Cash</option>
                        </select>
                    </div>
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">Save Reservation</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Reservation Modal -->
<div class="modal fade" id="editResModal" tabindex="-1" aria-labelledby="editResModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editResModalLabel">Edit Reservation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editResForm">
                    <input type="hidden" id="editResID">
                    <div class="mb-3">
                        <label for="editResCitizen" class="form-label">Citizen *</label>
                        <select id="editResCitizen" class="form-select" required></select>
                    </div>
                    <div class="mb-3">
                        <label for="editResSpot" class="form-label">Spot *</label>
                        <select id="editResSpot" class="form-select" required></select>
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label for="editResStart" class="form-label">Start Time *</label>
                            <input type="datetime-local" id="editResStart" class="form-control" required>
                        </div>
                        <div class="col-6 mb-3">
                            <label for="editResEnd" class="form-label">End Time *</label>
                            <input type="datetime-local" id="editResEnd" class="form-control" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editResAmount" class="form-label">Amount ($) *</label>
                        <input type="number" step="0.01" id="editResAmount" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="editResGateway" class="form-label">Payment Gateway *</label>
                        <select id="editResGateway" class="form-select" required>
                            <option value="Credit Card">Credit Card</option>
                            <option value="PayPal">PayPal</option>
                            <option value="Cash">Cash</option>
                        </select>
                    </div>
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">Update Reservation</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Add Parking Spot Modal -->
<div class="modal fade" id="addSpotModal" tabindex="-1" aria-labelledby="addSpotModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addSpotModalLabel">Add New Parking Spot</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addSpotForm">
                    <div class="mb-3">
                        <label for="addSpotID" class="form-label">Spot ID (Optional)</label>
                        <input type="number" id="addSpotID" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label for="addSpotLot" class="form-label">Lot *</label>
                        <select id="addSpotLot" class="form-select" required></select>
                    </div>
                    <div class="mb-3">
                        <label for="addSpotSensor" class="form-label">Sensor *</label>
                        <select id="addSpotSensor" class="form-select" required></select>
                    </div>
                    <div class="mb-3">
                        <label for="addSpotStatus" class="form-label">Status *</label>
                        <select id="addSpotStatus" class="form-select" required>
                            <option value="Available">Available</option>
                            <option value="Occupied">Occupied</option>
                            <option value="Maintenance">Maintenance</option>
                        </select>
                    </div>
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success">Add Parking Spot</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Parking Spot Modal -->
<div class="modal fade" id="editSpotModal" tabindex="-1" aria-labelledby="editSpotModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editSpotModalLabel">Edit Parking Spot</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editSpotForm">
                    <input type="hidden" id="editSpotID_Hidden">
                    <div class="mb-3">
                        <label class="form-label">Spot ID: <span id="editSpotDisplayID" class="fw-bold"></span></label>
                    </div>
                    <div class="mb-3">
                        <label for="editSpotLot" class="form-label">Lot *</label>
                        <select id="editSpotLot" class="form-select" required></select>
                    </div>
                    <div class="mb-3">
                        <label for="editSpotSensor" class="form-label">Sensor *</label>
                        <select id="editSpotSensor" class="form-select" required></select>
                    </div>
                    <div class="mb-3">
                        <label for="editSpotStatus" class="form-label">Status *</label>
                        <select id="editSpotStatus" class="form-select" required>
                            <option value="Available">Available</option>
                            <option value="Occupied">Occupied</option>
                            <option value="Maintenance">Maintenance</option>
                        </select>
                    </div>
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">Update Parking Spot</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>

        // Add role-based access control
    const userRole = sessionStorage.getItem('userRole') || 'admin'; // Default to admin for testing
    const isCitizen = userRole === 'citizen';
    
        // 1. ROLE-BASED ACCESS CONTROL
    function applyRolePermissions() {
        if (isCitizen) {
            // Hide Add buttons
            document.querySelector('[data-bs-target="#addResModal"]').style.display = 'none';
            document.querySelector('[data-bs-target="#addSpotModal"]').style.display = 'none';
            
            // Hide Actions headers in tables
            const tables = document.querySelectorAll('table');
            tables.forEach(table => {
                const headers = table.querySelectorAll('th');
                headers.forEach(header => {
                    if (header.textContent.includes('Action') || header.textContent.includes('Actions')) {
                        header.style.display = 'none';
                    }
                });
            });

            // Hide action buttons in both tables
            document.querySelectorAll('.action-buttons').forEach(cell => {
                cell.style.display = 'none';
            });
            
            console.log('Citizen view: CRUD operations disabled');
        } else {
            console.log('Admin view: Full CRUD operations enabled');
        }
    }

    


    document.addEventListener('DOMContentLoaded', () => {
        applyRolePermissions(); // ADD THIS LINE
        loadDropdowns();
        loadReservations();
        loadSpots();
        loadChart();
    });


    const API_PATH = 'api/parking';

    document.addEventListener('DOMContentLoaded', () => {
        loadDropdowns();
        loadReservations();
        loadSpots();
        loadChart();
    });

    // --- FILTER ---
    function filterTable(inputId, tbodyId) {
        const filter = document.getElementById(inputId).value.toLowerCase();
        const rows = document.getElementById(tbodyId).getElementsByTagName("tr");
        for (let row of rows) {
            row.style.display = row.textContent.toLowerCase().includes(filter) ? "" : "none";
        }
    }

    // --- LOAD RESERVATIONS (TABLE 1) ---
    async function loadReservations() {
        try {
            const res = await fetch(`${API_PATH}/reservations.php`);
            const data = await res.json();
            const tbody = document.getElementById('resBody');
            if(data.error) throw new Error(data.error);

            tbody.innerHTML = data.map(r => `
    <tr>
        <td>${r.reservationID}</td>
        <td>${r.spotID}</td>
        <td>${r.citizenID}</td>
        <td>${r.citizenName}</td>
        <td>${r.startTime}</td>
        <td>${r.endTime}</td>
        <td>$${parseFloat(r.amount).toFixed(2) || '0.00'}</td>  <!-- ADDED THIS LINE -->
        <td>${r.paymentGateway || '-'}</td>
        <td>${r.paymentDate || '-'}</td>
        <td class="action-buttons">
            <button class="btn btn-sm btn-info text-white me-1" onclick='openEditRes(${JSON.stringify(r)})'><i class="fas fa-edit"></i> Edit</button>
            <button class="btn btn-sm btn-danger" onclick="deleteRes(${r.reservationID})"><i class="fas fa-trash-alt"></i> Cancel</button>
        </td>
    </tr>
`).join('');
        } catch(e) { console.error(e); }
        applyRolePermissions();
    }
    

    // --- LOAD SPOTS (TABLE 2) ---
    async function loadSpots() {
        try {
            const res = await fetch(`${API_PATH}/spots.php`);
            const data = await res.json();
            const tbody = document.getElementById('spotBody');
            
            tbody.innerHTML = data.map(s => {
                const badgeClass = s.status === 'Available' ? 'bg-success' : 
                                 s.status === 'Occupied' ? 'bg-danger' : 'bg-secondary';
                
                return `
                <tr>
                    <td><strong>${s.spotID}</strong></td>
                    <td>${s.road || '-'}</td>
                    <td>${s.area || '-'}</td>
                    <td>${s.city || '-'}</td>
                    <td><span class="badge ${badgeClass}">${s.status}</span></td>
                    <td>${s.capacity || '-'}</td>
                    <td>${s.lotID}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-info text-white me-1" onclick='openEditSpot(${JSON.stringify(s)})'><i class="fas fa-edit"></i> Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteSpot(${s.spotID})"><i class="fas fa-trash-alt"></i> Delete</button>
                    </td>
                </tr>
                `;
            }).join('');
        } catch(e) { console.error(e); }
        applyRolePermissions();
    }

    // --- ADD/EDIT ACTIONS ---
    // Reservations - Add form with validation
    document.getElementById('addResForm').onsubmit = async (e) => {
    e.preventDefault();
    
    if (isCitizen) {
        alert('Citizens cannot add reservations.');
        return;
    }
    
    // Get form values
    const spotID = document.getElementById('addResSpot').value;
    const startTime = document.getElementById('addResStart').value;
    const endTime = document.getElementById('addResEnd').value;
    
    // Validate start time is before end time
    if (new Date(startTime) >= new Date(endTime)) {
        alert('Error: Start time must be before end time.');
        return;
    }
    
    // Check for reservation conflicts
    const hasConflict = await checkReservationConflict(spotID, startTime, endTime);
    if (hasConflict) {
        alert('Error: This parking spot is already reserved during the selected time period.');
        return;
    }
    
    await apiCall(`${API_PATH}/reservations.php`, 'POST', {
        citizenID: document.getElementById('addResCitizen').value,
        spotID: spotID,
        startTime: startTime,
        endTime: endTime,
        amount: document.getElementById('addResAmount').value,
        paymentGateway: document.getElementById('addResGateway').value
    });
    bootstrap.Modal.getInstance(document.getElementById('addResModal')).hide();
    loadReservations();
};

    // Reservations - Edit form with validation
    document.getElementById('editResForm').onsubmit = async (e) => {
    e.preventDefault();
    
    if (isCitizen) {
        alert('Citizens cannot edit reservations.');
        return;
    }
    
    // Get form values
    const reservationID = document.getElementById('editResID').value;
    const spotID = document.getElementById('editResSpot').value;
    const startTime = document.getElementById('editResStart').value;
    const endTime = document.getElementById('editResEnd').value;
    
    // Validate start time is before end time
    if (new Date(startTime) >= new Date(endTime)) {
        alert('Error: Start time must be before end time.');
        return;
    }
    
    // Check for reservation conflicts (excluding current reservation)
    const hasConflict = await checkReservationConflict(spotID, startTime, endTime, reservationID);
    if (hasConflict) {
        alert('Error: This parking spot is already reserved during the selected time period.');
        return;
    }
    
    await apiCall(`${API_PATH}/reservations.php`, 'PUT', {
        reservationID: reservationID,
        citizenID: document.getElementById('editResCitizen').value,
        spotID: spotID,
        startTime: startTime,
        endTime: endTime,
        amount: document.getElementById('editResAmount').value,
        paymentGateway: document.getElementById('editResGateway').value
    });
    bootstrap.Modal.getInstance(document.getElementById('editResModal')).hide();
    loadReservations();
};

    // Spots - Add form
    document.getElementById('addSpotForm').onsubmit = async (e) => {
        e.preventDefault();
        
        if (isCitizen) {
            alert('Citizens cannot add parking spots.');
            return;
        }
        
        await apiCall(`${API_PATH}/spots.php`, 'POST', {
            spotID: document.getElementById('addSpotID').value,
            lotID: document.getElementById('addSpotLot').value,
            sensorID: document.getElementById('addSpotSensor').value,
            status: document.getElementById('addSpotStatus').value
        });
        bootstrap.Modal.getInstance(document.getElementById('addSpotModal')).hide();
        loadSpots();
    };

    // Spots - Edit form
    document.getElementById('editSpotForm').onsubmit = async (e) => {
        e.preventDefault();
        
        if (isCitizen) {
            alert('Citizens cannot edit parking spots.');
            return;
        }
        
        await apiCall(`${API_PATH}/spots.php`, 'PUT', {
            spotID: document.getElementById('editSpotID_Hidden').value,
            lotID: document.getElementById('editSpotLot').value,
            sensorID: document.getElementById('editSpotSensor').value,
            status: document.getElementById('editSpotStatus').value
        });
        bootstrap.Modal.getInstance(document.getElementById('editSpotModal')).hide();
        loadSpots();
    };

    document.getElementById('editResForm').onsubmit = async (e) => {
        e.preventDefault();
        await apiCall(`${API_PATH}/reservations.php`, 'PUT', {
            reservationID: document.getElementById('editResID').value,
            citizenID: document.getElementById('editResCitizen').value,
            spotID: document.getElementById('editResSpot').value,
            startTime: document.getElementById('editResStart').value,
            endTime: document.getElementById('editResEnd').value,
            amount: document.getElementById('editResAmount').value,
            paymentGateway: document.getElementById('editResGateway').value
        });
        bootstrap.Modal.getInstance(document.getElementById('editResModal')).hide();
        loadReservations();
    };

    // Spots
    document.getElementById('addSpotForm').onsubmit = async (e) => {
        e.preventDefault();
        await apiCall(`${API_PATH}/spots.php`, 'POST', {
            spotID: document.getElementById('addSpotID').value,
            lotID: document.getElementById('addSpotLot').value,
            sensorID: document.getElementById('addSpotSensor').value,
            status: document.getElementById('addSpotStatus').value
        });
        bootstrap.Modal.getInstance(document.getElementById('addSpotModal')).hide();
        loadSpots();
    };

    document.getElementById('editSpotForm').onsubmit = async (e) => {
        e.preventDefault();
        await apiCall(`${API_PATH}/spots.php`, 'PUT', {
            spotID: document.getElementById('editSpotID_Hidden').value,
            lotID: document.getElementById('editSpotLot').value,
            sensorID: document.getElementById('editSpotSensor').value,
            status: document.getElementById('editSpotStatus').value
        });
        bootstrap.Modal.getInstance(document.getElementById('editSpotModal')).hide();
        loadSpots();
    };

    // --- HELPERS ---
        window.openEditRes = (r) => {
        if (isCitizen) {
            alert('Citizens cannot edit reservations.');
            return;
        }
        document.getElementById('editResID').value = r.reservationID;
        document.getElementById('editResCitizen').value = r.citizenID;
        document.getElementById('editResSpot').value = r.spotID;
        document.getElementById('editResStart').value = r.startTime ? r.startTime.replace(' ', 'T') : '';
        document.getElementById('editResEnd').value = r.endTime ? r.endTime.replace(' ', 'T') : '';
        document.getElementById('editResAmount').value = r.amount;
        document.getElementById('editResGateway').value = r.paymentGateway || 'Credit Card';
        new bootstrap.Modal(document.getElementById('editResModal')).show();
    };

    window.openEditSpot = (s) => {
        if (isCitizen) {
            alert('Citizens cannot edit parking spots.');
            return;
        }
        document.getElementById('editSpotID_Hidden').value = s.spotID;
        document.getElementById('editSpotDisplayID').innerText = s.spotID;
        document.getElementById('editSpotLot').value = s.lotID;
        document.getElementById('editSpotSensor').value = s.sensorID;
        document.getElementById('editSpotStatus').value = s.status || 'Available';
        new bootstrap.Modal(document.getElementById('editSpotModal')).show();
    };

    window.openEditSpot = (s) => {
        document.getElementById('editSpotID_Hidden').value = s.spotID;
        document.getElementById('editSpotDisplayID').innerText = s.spotID;
        document.getElementById('editSpotLot').value = s.lotID;
        document.getElementById('editSpotSensor').value = s.sensorID;
        document.getElementById('editSpotStatus').value = s.status || 'Available';
        new bootstrap.Modal(document.getElementById('editSpotModal')).show();
    };

        window.deleteRes = async (id) => { 
        if (isCitizen) {
            alert('Citizens cannot cancel reservations.');
            return;
        }
        if(confirm('Are you sure you want to cancel this reservation?')) { 
            await apiCall(`${API_PATH}/reservations.php?id=${id}`, 'DELETE'); 
            loadReservations(); 
        } 
    };
    
    window.deleteSpot = async (id) => { 
        if (isCitizen) {
            alert('Citizens cannot delete parking spots.');
            return;
        }
        if(confirm('Are you sure you want to delete this parking spot? This action cannot be undone.')) { 
            await apiCall(`${API_PATH}/spots.php?id=${id}`, 'DELETE'); 
            loadSpots(); 
        } 
    };
    
    window.deleteSpot = async (id) => { 
        if(confirm('Are you sure you want to delete this parking spot? This action cannot be undone.')) { 
            await apiCall(`${API_PATH}/spots.php?id=${id}`, 'DELETE'); 
            loadSpots();
        } 
    };

    async function apiCall(url, method, body) {
        const res = await fetch(url, { method: method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
        const json = await res.json();
        if(json.error) alert(json.error);
    }

    async function checkReservationConflict(spotID, startTime, endTime, excludeReservationID = null) {
    try {
        // Fetch all reservations for the specific spot
        const res = await fetch(`${API_PATH}/reservations.php`);
        const reservations = await res.json();
        
        const newStart = new Date(startTime);
        const newEnd = new Date(endTime);
        
        // Check each existing reservation for the same spot
        for (const reservation of reservations) {
            // Skip the reservation being edited
            if (excludeReservationID && reservation.reservationID == excludeReservationID) {
                continue;
            }
            
            // Only check reservations for the same spot
            if (reservation.spotID == spotID) {
                const existingStart = new Date(reservation.startTime);
                const existingEnd = new Date(reservation.endTime);
                
                // Check for time overlap
                if ((newStart >= existingStart && newStart < existingEnd) ||
                    (newEnd > existingStart && newEnd <= existingEnd) ||
                    (newStart <= existingStart && newEnd >= existingEnd)) {
                    return true; // Conflict found
                }
            }
        }
        
        return false; // No conflicts
    } catch (error) {
        console.error('Error checking reservation conflicts:', error);
        return false; // Assume no conflict if there's an error
    }
}


    async function loadDropdowns() {
        // Load Citizens, Spots, Lots, Sensors
        const [cit, spots, lots, sensors] = await Promise.all([
            fetch(`${API_PATH}/lists.php?type=citizens`).then(r=>r.json()),
            fetch(`${API_PATH}/lists.php?type=spots`).then(r=>r.json()),
            fetch(`${API_PATH}/lists.php?type=lots`).then(r=>r.json()),
            fetch(`${API_PATH}/lists.php?type=sensors`).then(r=>r.json())
        ]);
        
        // Populate Reservation Modals
        const citHTML = cit.map(c => `<option value="${c.citizenID}">${c.fname} ${c.lname}</option>`).join('');
        document.getElementById('addResCitizen').innerHTML = citHTML;
        document.getElementById('editResCitizen').innerHTML = citHTML;

        const spotHTML = spots.map(s => `<option value="${s.spotID}">Spot ${s.spotID}</option>`).join('');
        document.getElementById('addResSpot').innerHTML = spotHTML;
        document.getElementById('editResSpot').innerHTML = spotHTML;

        // Populate Spot Modals
        const lotHTML = lots.map(l => `<option value="${l.lotID}">${l.road} (${l.area})</option>`).join('');
        document.getElementById('addSpotLot').innerHTML = lotHTML;
        document.getElementById('editSpotLot').innerHTML = lotHTML;

        const senHTML = sensors.map(s => `<option value="${s.sensorID}">Sensor ${s.sensorID}</option>`).join('');
        document.getElementById('addSpotSensor').innerHTML = senHTML;
        document.getElementById('editSpotSensor').innerHTML = senHTML;
    }

    async function loadChart() {
        const res = await fetch(`${API_PATH}/chart.php`);
        const data = await res.json();
        if(window.myChart) window.myChart.destroy();
        window.myChart = new Chart(document.getElementById('parkingChart'), {
            type: 'line',
            data: {
                labels: data.map(d=>d.date),
                datasets: [{ label: 'Revenue', data: data.map(d=>d.total_revenue), borderColor: '#3498db', fill: true }]
            }
        });
    }
</script>
</body>
</html>