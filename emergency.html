<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency Response | Smart City Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* EXACTLY matching your original sidebar style */
        .sidebar {
            height: 100vh;
            background-color: #2c3e50;
            padding-top: 20px;
            position: fixed;
            width: 250px;
        }
        .sidebar a {
            color: #ecf0f1;
            padding: 15px 20px;
            text-decoration: none;
            display: block;
            border-bottom: 1px solid #34495e;
        }
        .sidebar a:hover, .sidebar .active {
            background-color: #3498db;
            color: white;
        }
        .main-content {
            padding: 30px;
            margin-left: 250px;
        }
        
        /* Your original priority colors */
        .incident-high { color: #dc3545; font-weight: bold; }
        .incident-medium { color: #ffc107; font-weight: bold; }
        .incident-low { color: #0dcaf0; font-weight: bold; }
        .incident-critical { color: #8b0000; font-weight: bold; }
        
        /* Additional styles for enhanced features */
        .stat-card {
            border-radius: 10px;
            border: none;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
            height: 100%;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .table-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .chart-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            border: 1px solid #f1f1f1;
        }
        
        .badge-priority {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .priority-high { background-color: #fee; color: #d63031; border: 1px solid #ffcccc; }
        .priority-medium { background-color: #fff9e6; color: #e17055; border: 1px solid #ffeaa7; }
        .priority-low { background-color: #e8f6f3; color: #00b894; border: 1px solid #81ecec; }
        .priority-critical { background-color: #ffebee; color: #c62828; border: 1px solid #ef9a9a; }
        
        .badge-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-reported { background-color: #e3f2fd; color: #1565c0; }
        .status-dispatched { background-color: #fff3e0; color: #ef6c00; }
        .status-onscene { background-color: #e8f5e9; color: #2e7d32; }
        .status-resolved { background-color: #f3e5f5; color: #7b1fa2; }
        .status-closed { background-color: #f5f5f5; color: #616161; }
        
        #emergencyMap { 
            height: 300px; 
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
        }
        
        .metric-label {
            font-size: 13px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Make it responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 0;
                overflow: hidden;
            }
            .main-content {
                margin-left: 0;
                padding: 15px;
            }
        }
    </style>
</head>
<body>

<div class="d-flex">
    <!-- Sidebar - EXACTLY like your original -->
    <div class="sidebar d-flex flex-column" style="width: 250px;">
        <h4 class="text-white text-center mb-4">Smart City Portal</h4>
        <a href="dashboard.html"><i class="fas fa-th-large me-2"></i> Dashboard</a>
        <a href="traffic.html"><i class="fas fa-car-side me-2"></i> Traffic Management</a>
        <a href="parking.html"><i class="fas fa-parking me-2"></i> Smart Parking System</a>
        <a href="waste.html"><i class="fas fa-trash-alt me-2"></i> Waste Management</a>
        <a href="energy.html"><i class="fas fa-bolt me-2"></i> Energy Monitoring</a>
        <a href="pollution.html"><i class="fas fa-smog me-2"></i> Air Quality Monitoring</a>
        <a href="emergency.html" class="active"><i class="fas fa-ambulance me-2"></i> Emergency Response</a>
        <a href="index.html" class="mt-auto" onclick="sessionStorage.removeItem('userRole');"><i class="fas fa-sign-out-alt me-2"></i> Logout</a>
    </div>

    <!-- Main Content -->
    <div class="main-content flex-grow-1">
        <!-- Header - EXACTLY like your original -->
        <header class="mb-5 border-bottom pb-3">
            <h1>Emergency Response & Public Safety System</h1>
            <p class="lead text-muted">Connect emergency services and optimize response times using data and AI (Tables: <strong>Incidents</strong>, <strong>EmergencyVehicles</strong>, <strong>ResponseTimes</strong>).</p>
        </header>

        <!-- Active Incident Map & Risk Zones - Enhanced but keeping your structure -->
        <section class="mb-5 p-4 border rounded shadow-sm bg-white">
            <h2 class="h4 mb-3"><i class="fas fa-map-marker-alt me-2 text-danger"></i> Active Incident Map & Risk Zones</h2>
            <div id="emergencyMap" class="mb-4">
                <!-- Map will be loaded here -->
            </div>
            
            <div class="row mt-4 text-center">
                <div class="col-md-6">
                    <div class="p-3 bg-light rounded">
                        <h5 class="text-secondary">Average Response Time (Last 24h)</h5>
                        <p class="metric-value text-danger" id="avgResponseTime">7:35 min</p>
                        <p class="text-success small">Target: 8:00 min (Status: Optimal)</p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="p-3 bg-light rounded">
                        <h5 class="text-secondary">AI Predicted High Risk Zone</h5>
                        <p class="metric-value text-danger" id="aiRiskZone">District C</p>
                        <p class="text-warning small">Reason: Traffic Congestion + Nighttime Activity</p>
                    </div>
                </div>
            </div>
        </section>
        
        <hr>

        <!-- Statistics Cards Row -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="stat-card border-start border-4 border-primary">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <div class="metric-label">Active Incidents</div>
                                <div class="metric-value" id="activeIncidentsCount">0</div>
                            </div>
                            <div class="text-primary">
                                <i class="fas fa-exclamation-triangle fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3 mb-3">
                <div class="stat-card border-start border-4 border-success">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <div class="metric-label">High Priority</div>
                                <div class="metric-value" id="highPriorityCount">0</div>
                            </div>
                            <div class="text-success">
                                <i class="fas fa-fire fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3 mb-3">
                <div class="stat-card border-start border-4 border-info">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <div class="metric-label">Available Vehicles</div>
                                <div class="metric-value" id="availableVehicles">12</div>
                            </div>
                            <div class="text-info">
                                <i class="fas fa-ambulance fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3 mb-3">
                <div class="stat-card border-start border-4 border-warning">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <div class="metric-label">Success Rate</div>
                                <div class="metric-value" id="successRate">94.7%</div>
                            </div>
                            <div class="text-warning">
                                <i class="fas fa-chart-line fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="chart-card">
                    <h5 class="mb-3"><i class="fas fa-chart-line text-primary me-2"></i>Response Time Trends</h5>
                    <canvas id="responseTimeChart" height="200"></canvas>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="chart-card">
                    <h5 class="mb-3"><i class="fas fa-chart-pie text-success me-2"></i>Incident Type Distribution</h5>
                    <canvas id="incidentTypeChart" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- Emergency Vehicles Table -->
        <div class="table-container mb-4">
            <h5 class="mb-3"><i class="fas fa-ambulance text-info me-2"></i> Emergency Vehicle Status (Table: EmergencyVehicles)</h5>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Vehicle ID</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Current Location</th>
                            <th>Assigned Incident</th>
                            <th>Last Updated</th>
                        </tr>
                    </thead>
                    <tbody id="vehiclesTableBody">
                        <!-- Vehicle data loaded by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Incident Log - Keeping your original structure but enhanced -->
        <section class="mb-5">
            <h2 class="h4 mb-4"><i class="fas fa-clipboard-list me-2 text-danger"></i> Active Incident Log (Table: Incidents)</h2>
            
            <div class="d-flex justify-content-between mb-3">
                <div class="input-group" style="width: 350px;">
                    <input type="text" class="form-control" placeholder="Search by Location or Type" aria-label="Search Incident Data" id="searchIncidentData">
                    <button class="btn btn-outline-secondary" type="button"><i class="fas fa-search"></i></button>
                </div>

                <button class="btn btn-success" id="btnAddIncident" data-bs-toggle="modal" data-bs-target="#addIncidentModal">
                    <i class="fas fa-plus me-1"></i> Log New Incident
                </button>
            </div>

            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Incident ID</th>
                            <th>Type</th>
                            <th>Location</th>
                            <th>Time Reported</th>
                            <th>Priority</th>
                            <th>Status</th>
                            <th id="actionsHeader">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="incidentTableBody">
                        <!-- Data loaded by JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <nav aria-label="Incident pagination" class="mt-3">
                <ul class="pagination justify-content-center" id="incidentPagination">
                    <!-- Pagination will be generated by JavaScript -->
                </ul>
            </nav>
        </section>

        <!-- Response Times Table -->
        <div class="table-container">
            <h5 class="mb-3"><i class="fas fa-clock text-warning me-2"></i> Response Time Analysis (Table: ResponseTimes)</h5>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Incident ID</th>
                            <th>Type</th>
                            <th>Location</th>
                            <th>Report Time</th>
                            <th>Dispatch Time</th>
                            <th>Arrival Time</th>
                            <th>Total Response</th>
                            <th>Service Type</th>
                            <th>Performance</th>
                        </tr>
                    </thead>
                    <tbody id="responseTimesTableBody">
                        <!-- Response times data loaded by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Incident Modal (same as your original but enhanced) -->
<div class="modal fade" id="addIncidentModal" tabindex="-1" aria-labelledby="addIncidentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addIncidentModalLabel">Log/Update Incident</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="incidentForm">
                    <input type="hidden" id="incidentId">
                    <div class="mb-3">
                        <label for="incidentType" class="form-label">Incident Type</label>
                        <select class="form-select" id="incidentType">
                            <option value="Vehicle Accident">Vehicle Accident</option>
                            <option value="Fire">Fire</option>
                            <option value="Crime">Crime/Security Issue</option>
                            <option value="Medical Emergency">Medical Emergency</option>
                            <option value="Natural Disaster">Natural Disaster</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="incidentLocation" class="form-label">Location</label>
                        <input type="text" class="form-control" id="incidentLocation" required>
                    </div>
                    <div class="mb-3">
                        <label for="priority" class="form-label">Priority</label>
                        <select class="form-select" id="priority">
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                            <option value="Critical">Critical</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="status" class="form-label">Status</label>
                        <select class="form-select" id="status">
                            <option value="Reported">Reported</option>
                            <option value="Dispatched">Dispatched</option>
                            <option value="On Scene">On Scene</option>
                            <option value="Resolved">Resolved</option>
                            <option value="Closed">Closed</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" rows="3" placeholder="Brief description of the incident"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="assignedVehicle" class="form-label">Assigned Vehicle</label>
                        <select class="form-select" id="assignedVehicle">
                            <option value="">Select vehicle</option>
                            <!-- Options loaded by JavaScript -->
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Save/Update Incident</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title text-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirm Action
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <i class="fas fa-question-circle fa-3x text-warning mb-3"></i>
                <h5 id="confirmMessage">Are you sure?</h5>
                <p id="confirmDetails" class="text-muted"></p>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmActionBtn">
                    <i class="fas fa-trash me-1"></i>Confirm
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- Leaflet JS for Map -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script>
    // Configuration
    const API_BASE_URL = 'http://localhost/smart-city/api'; // Update with your backend URL
    const userRole = sessionStorage.getItem('userRole') || 'admin';
    const isCitizen = userRole === 'citizen';
    
    // Global variables
    let incidents = [];
    let vehicles = [];
    let currentPage = 1;
    const itemsPerPage = 10;
    let map = null;
    let responseTimeChart = null;
    let incidentTypeChart = null;
    let incidentToDelete = null;

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        initCharts();
        initMap();
        applyRolePermissions();
        loadIncidents();
        loadEmergencyVehicles();
        loadResponseTimes();
        setupEventListeners();
        
        // Auto-refresh every 30 seconds
        setInterval(loadIncidents, 30000);
    });

    // 1. Initialize charts
    function initCharts() {
        // Response Time Chart
        const responseCtx = document.getElementById('responseTimeChart').getContext('2d');
        responseTimeChart = new Chart(responseCtx, {
            type: 'line',
            data: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                datasets: [{
                    label: 'Response Time (minutes)',
                    data: [8.2, 7.8, 7.5, 7.2, 7.0, 7.5, 7.8],
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        min: 6,
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });
        
        // Incident Type Chart
        const typeCtx = document.getElementById('incidentTypeChart').getContext('2d');
        incidentTypeChart = new Chart(typeCtx, {
            type: 'doughnut',
            data: {
                labels: ['Accidents', 'Medical', 'Fire', 'Crime', 'Other'],
                datasets: [{
                    data: [35, 25, 20, 15, 5],
                    backgroundColor: [
                        '#dc3545', '#0dcaf0', '#ffc107', '#198754', '#6f42c1'
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                cutout: '70%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    }
                }
            }
        });
    }

    // 2. Initialize map
    function initMap() {
        map = L.map('emergencyMap').setView([51.505, -0.09], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);
        
        // Add a default marker
        L.marker([51.505, -0.09]).addTo(map)
            .bindPopup('<b>City Center</b><br>Emergency Services HQ')
            .openPopup();
    }

    // 3. Role-based permissions (from your original code)
    function applyRolePermissions() {
        if (isCitizen) {
            // Citizens can VIEW the log but cannot add/edit/delete incidents
            document.getElementById('btnAddIncident').style.display = 'none';
            document.getElementById('actionsHeader').style.display = 'none';
        }
    }

    // 4. Load incidents (with mock data for demonstration)
    async function loadIncidents() {
        try {
            // Mock data - Replace with actual API call
            const mockIncidents = [
                {
                    id: 'I001',
                    type: 'Vehicle Accident',
                    location: 'Main St Bridge',
                    time_reported: '2025-11-28 17:30:00',
                    priority: 'High',
                    status: 'Dispatched',
                    description: 'Two-car collision with injuries',
                    assigned_vehicle: 'AMB-001',
                    latitude: 51.505,
                    longitude: -0.09
                },
                {
                    id: 'I002',
                    type: 'Fire',
                    location: 'Industrial Park Warehouse 4',
                    time_reported: '2025-11-28 16:00:00',
                    priority: 'Medium',
                    status: 'On Scene',
                    description: 'Minor electrical fire',
                    assigned_vehicle: 'FR-001',
                    latitude: 51.51,
                    longitude: -0.1
                },
                {
                    id: 'I003',
                    type: 'Medical Emergency',
                    location: 'Central Hospital',
                    time_reported: '2025-11-28 14:20:00',
                    priority: 'Critical',
                    status: 'Resolved',
                    description: 'Heart attack patient',
                    assigned_vehicle: 'AMB-002',
                    latitude: 51.50,
                    longitude: -0.08
                },
                {
                    id: 'I004',
                    type: 'Crime',
                    location: 'Downtown Mall',
                    time_reported: '2025-11-28 13:45:00',
                    priority: 'Medium',
                    status: 'Reported',
                    description: 'Suspicious activity reported',
                    assigned_vehicle: 'POL-001',
                    latitude: 51.495,
                    longitude: -0.095
                }
            ];
            
            incidents = mockIncidents;
            renderIncidentTable(incidents);
            updateMap(incidents);
            updateStatistics();
            
        } catch (error) {
            console.error('Error loading incidents:', error);
            showAlert('Error loading incidents. Please try again.', 'danger');
        }
    }

    // 5. Render incident table (keeping your original structure)
    function renderIncidentTable(incidents) {
        const tbody = document.getElementById('incidentTableBody');
        
        if (incidents.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-5">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No incidents found</h5>
                        <p class="text-muted">Start by adding a new incident</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = incidents.map(incident => `
            <tr>
                <td>${incident.id}</td>
                <td>${incident.type}</td>
                <td>${incident.location}</td>
                <td>${formatDateTime(incident.time_reported)}</td>
                <td><span class="incident-${incident.priority.toLowerCase()}">${incident.priority}</span></td>
                <td><span class="badge-status status-${incident.status.toLowerCase().replace(' ', '')}">${incident.status}</span></td>
                <td class="action-buttons" ${isCitizen ? 'style="display: none;"' : ''}>
                    <button class="btn btn-sm btn-info text-white me-1 edit-btn" data-id="${incident.id}" data-bs-toggle="modal" data-bs-target="#addIncidentModal"><i class="fas fa-edit"></i> Update</button>
                    <button class="btn btn-sm btn-danger delete-btn" data-id="${incident.id}"><i class="fas fa-times"></i> Close</button>
                </td>
            </tr>
        `).join('');
        
        attachRowEventListeners();
    }

    // 6. Update map with incidents
    function updateMap(incidents) {
        // Clear existing markers (except base layers)
        map.eachLayer(layer => {
            if (layer instanceof L.Marker) {
                map.removeLayer(layer);
            }
        });
        
        // Add markers for each incident
        incidents.forEach(incident => {
            if (incident.latitude && incident.longitude) {
                const marker = L.marker([incident.latitude, incident.longitude])
                    .addTo(map)
                    .bindPopup(`
                        <b>${incident.type}</b><br>
                        <small>${incident.location}</small><br>
                        <span class="badge bg-${getPriorityColor(incident.priority)}">${incident.priority}</span><br>
                        <small>Status: ${incident.status}</small>
                    `);
                
                // Custom icon based on priority
                const icon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background-color: ${getMarkerColor(incident.priority)}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);"></div>`,
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });
                
                marker.setIcon(icon);
            }
        });
    }

    // 7. Load emergency vehicles
    async function loadEmergencyVehicles() {
        try {
            // Mock data - Replace with actual API call
            vehicles = [
                { id: 'AMB-001', type: 'Ambulance', status: 'Available', location: 'Main Hospital', assigned: '', updated: '2 min ago' },
                { id: 'FR-001', type: 'Fire Truck', status: 'Busy', location: 'Industrial Park', assigned: 'I002', updated: 'Now' },
                { id: 'POL-001', type: 'Police Car', status: 'On Duty', location: 'Central Station', assigned: 'I001', updated: '5 min ago' },
                { id: 'AMB-002', type: 'Ambulance', status: 'Available', location: 'East Clinic', assigned: '', updated: '10 min ago' }
            ];
            
            const tbody = document.getElementById('vehiclesTableBody');
            tbody.innerHTML = vehicles.map(vehicle => `
                <tr>
                    <td>${vehicle.id}</td>
                    <td>${vehicle.type}</td>
                    <td>${vehicle.status}</td>
                    <td>${vehicle.location}</td>
                    <td>${vehicle.assigned || '-'}</td>
                    <td>${vehicle.updated}</td>
                </tr>
            `).join('');
            
            // Update vehicle dropdown in modal
            const select = document.getElementById('assignedVehicle');
            select.innerHTML = '<option value="">Select vehicle</option>';
            
            vehicles.forEach(vehicle => {
                const option = document.createElement('option');
                option.value = vehicle.id;
                option.textContent = `${vehicle.type} - ${vehicle.id}`;
                select.appendChild(option);
            });
            
        } catch (error) {
            console.error('Error loading vehicles:', error);
        }
    }

    // 8. Load response times
    async function loadResponseTimes() {
        try {
            // Mock data - Replace with actual API call
            const responseTimes = [
                { incident_id: 'I001', type: 'Accident', location: 'Main St', report_time: '17:30:00', dispatch_time: '17:31:20', arrival_time: '17:37:15', response: '6:55', service: 'Police', performance: 'Optimal' },
                { incident_id: 'I002', type: 'Fire', location: 'Industrial Park', report_time: '16:00:00', dispatch_time: '16:02:30', arrival_time: '16:09:45', response: '7:45', service: 'Fire Dept', performance: 'Good' },
                { incident_id: 'I003', type: 'Medical', location: 'Residential B', report_time: '14:20:00', dispatch_time: '14:21:45', arrival_time: '14:26:30', response: '5:30', service: 'Ambulance', performance: 'Excellent' }
            ];
            
            const tbody = document.getElementById('responseTimesTableBody');
            tbody.innerHTML = responseTimes.map(rt => `
                <tr>
                    <td>${rt.incident_id}</td>
                    <td>${rt.type}</td>
                    <td>${rt.location}</td>
                    <td>${rt.report_time}</td>
                    <td>${rt.dispatch_time}</td>
                    <td>${rt.arrival_time}</td>
                    <td><span class="badge bg-success">${rt.response} min</span></td>
                    <td>${rt.service}</td>
                    <td><span class="badge bg-success">${rt.performance}</span></td>
                </tr>
            `).join('');
            
        } catch (error) {
            console.error('Error loading response times:', error);
        }
    }

    // 9. Update statistics
    function updateStatistics() {
        const activeIncidents = incidents.filter(i => i.status !== 'Resolved' && i.status !== 'Closed').length;
        const highPriority = incidents.filter(i => i.priority === 'High' || i.priority === 'Critical').length;
        
        document.getElementById('activeIncidentsCount').textContent = activeIncidents;
        document.getElementById('highPriorityCount').textContent = highPriority;
        document.getElementById('availableVehicles').textContent = vehicles.filter(v => v.status === 'Available').length;
        document.getElementById('successRate').textContent = '94.7%';
        document.getElementById('aiRiskZone').textContent = 'District C';
        document.getElementById('avgResponseTime').textContent = '7:35 min';
    }

    // 10. Setup event listeners
    function setupEventListeners() {
        // Search functionality (from your original code)
        document.getElementById('searchIncidentData').addEventListener('keyup', function() {
            const searchText = this.value.toLowerCase();
            const rows = document.getElementById('incidentTableBody').getElementsByTagName('tr');
            
            Array.from(rows).forEach(row => {
                const rowText = row.textContent.toLowerCase();
                row.style.display = rowText.includes(searchText) ? '' : 'none';
            });
        });

        // Form submission (enhanced from your original)
        document.getElementById('incidentForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            
            if (isCitizen) return; 
            
            const incidentId = document.getElementById('incidentId').value;
            const location = document.getElementById('incidentLocation').value;
            
            if (incidentId) {
                // Update existing incident
                showAlert(`Updating Incident ID ${incidentId} (Location: ${location})`, 'info');
                // TODO: Implement AJAX PUT request
            } else {
                // Create new incident
                showAlert(`Creating new Incident (Location: ${location})`, 'success');
                // TODO: Implement AJAX POST request
            }
            
            const modalElement = document.getElementById('addIncidentModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) modal.hide();
            
            // Reload data
            setTimeout(() => {
                loadIncidents();
                loadEmergencyVehicles();
            }, 1000);
        });

        // Confirm delete button
        document.getElementById('confirmActionBtn').addEventListener('click', async function() {
            if (!incidentToDelete) return;
            
            try {
                showAlert(`Closing Incident ID ${incidentToDelete}`, 'info');
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('confirmModal'));
                modal.hide();
                
                // Update local data
                const index = incidents.findIndex(i => i.id === incidentToDelete);
                if (index !== -1) {
                    incidents[index].status = 'Closed';
                    renderIncidentTable(incidents);
                    updateStatistics();
                }
                
            } catch (error) {
                showAlert('Error closing incident: ' + error.message, 'danger');
            }
            
            incidentToDelete = null;
        });
        
        // Add incident button
        document.getElementById('btnAddIncident').addEventListener('click', function() {
            document.getElementById('addIncidentModalLabel').textContent = 'Log New Incident';
            document.getElementById('incidentForm').reset();
            document.getElementById('incidentId').value = '';
        });
    }

    // 11. Attach event listeners to table rows
    function attachRowEventListeners() {
        // Edit buttons
        document.querySelectorAll('.edit-btn').forEach(button => {
            button.addEventListener('click', function() {
                if (isCitizen) return;
                
                const id = this.getAttribute('data-id');
                const incident = incidents.find(i => i.id === id);
                
                if (incident) {
                    document.getElementById('addIncidentModalLabel').textContent = `Update Incident ${id}`;
                    document.getElementById('incidentId').value = incident.id;
                    document.getElementById('incidentType').value = incident.type;
                    document.getElementById('incidentLocation').value = incident.location;
                    document.getElementById('priority').value = incident.priority;
                    document.getElementById('status').value = incident.status;
                    document.getElementById('description').value = incident.description || '';
                    document.getElementById('assignedVehicle').value = incident.assigned_vehicle || '';
                }
            });
        });
        
        // Delete buttons
        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', function() {
                if (isCitizen) return;
                
                const id = this.getAttribute('data-id');
                const incident = incidents.find(i => i.id === id);
                
                if (incident) {
                    incidentToDelete = id;
                    
                    document.getElementById('confirmMessage').textContent = `Close Incident ${id}?`;
                    document.getElementById('confirmDetails').textContent = `This will mark the ${incident.type} incident at ${incident.location} as closed.`;
                    
                    const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
                    modal.show();
                }
            });
        });
    }

    // 12. Utility functions
    function formatDateTime(dateTime) {
        return new Date(dateTime).toLocaleString();
    }
    
    function getPriorityColor(priority) {
        switch(priority.toLowerCase()) {
            case 'critical': return 'danger';
            case 'high': return 'warning';
            case 'medium': return 'info';
            case 'low': return 'success';
            default: return 'secondary';
        }
    }
    
    function getMarkerColor(priority) {
        switch(priority.toLowerCase()) {
            case 'critical': return '#c62828';
            case 'high': return '#e74c3c';
            case 'medium': return '#f39c12';
            case 'low': return '#2ecc71';
            default: return '#3498db';
        }
    }
    
    function showAlert(message, type) {
        // Remove existing alerts
        const existingAlert = document.querySelector('.alert');
        if (existingAlert) existingAlert.remove();
        
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(alertDiv);
        
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 3000);
    }
</script>
</body>
</html>
